# Copyright 2023 Nokia
# Licensed under the BSD 3-Clause License.
# SPDX-License-Identifier: BSD-3-Clause

- name: TLS missed check fail
  hosts: clab
  gather_facts: false
  vars:
    ansible_httpapi_use_ssl: true
  tasks:
    - name: Get with TLS required but without setting skip verify or custom ca cert
      nokia.srlinux.get:
        paths:
          - path: /system/information
            datastore: state
      register: get_return
      ignore_errors: true

    - name: Print debug
      ansible.builtin.debug:
        var: get_return

    - name: Check the expected failure occurred
      ansible.builtin.assert:
        that:
          - get_return.failed
          - >-
            "CERTIFICATE_VERIFY_FAILED" in (get_return.module_stderr | default('')) or
            "CERTIFICATE_VERIFY_FAILED" in (get_return.msg | default(''))
        fail_msg: "Expected CERTIFICATE_VERIFY_FAILED error did not occur"

    - name: Print debug
      ansible.builtin.debug:
        var: get_return
